<!DOCTYPE html>
<html>
<head>
    <title>Test Duplicate Commands</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
    <div id="editor">
        <div class="sentence-wrapper">
            <div class="sentence-line empty" data-id="test-sentence-1" data-prev-id="">Test content</div>
        </div>
    </div>
    
    <div id="log"></div>
    
    <script>
        // Mock variables and functions for testing
        let stompClient = {
            connected: true,
            send: function(endpoint, headers, data) {
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `<strong>SENT:</strong> ${endpoint} - ${data}`;
                document.getElementById('log').appendChild(logEntry);
                console.log('SENT:', endpoint, data);
            }
        };
        
        let currentDocumentId = 'test-document';
        let sessionId = 'test-session';
        let sentenceCounter = 0;
        
        function generateSentenceId() {
            return 'sentence-' + Date.now() + '-' + (++sentenceCounter);
        }
        
        // Simulate key press event
        function simulateEnterKey() {
            const element = document.querySelector('.sentence-line');
            const textarea = document.createElement('textarea');
            textarea.value = 'Test content';
            textarea.selectionStart = 12; // at end
            
            // Simulate the Enter key handling
            handleEnterKey(element, textarea);
        }
        
        // Copy the functions from editor.js that we need to test
        function sendTwoSentenceUpdate(firstRequest, secondRequest, callback) {
            if (stompClient && stompClient.connected && currentDocumentId) {
                const twoSentenceRequest = {
                    firstRequest: {
                        id: firstRequest.id,
                        prevId: firstRequest.prevId,
                        rootDocumentId: currentDocumentId,
                        content: firstRequest.content,
                        sessionId: sessionId
                    },
                    secondRequest: {
                        id: secondRequest.id,
                        prevId: secondRequest.prevId,
                        rootDocumentId: currentDocumentId,
                        content: secondRequest.content,
                        sessionId: sessionId
                    }
                };

                stompClient.send('/app/sentence/publish/two', {}, JSON.stringify(twoSentenceRequest));

                if (callback) {
                    setTimeout(callback, 50);
                }
            } else if (callback) {
                callback();
            }
        }
        
        function createSentenceWrapper(id, prevId, content) {
            const wrapper = document.createElement('div');
            wrapper.className = 'sentence-wrapper';
            const sentenceLine = document.createElement('div');
            sentenceLine.className = 'sentence-line';
            sentenceLine.setAttribute('data-id', id);
            sentenceLine.setAttribute('data-prev-id', prevId);
            sentenceLine.textContent = content;
            wrapper.appendChild(sentenceLine);
            return wrapper;
        }
        
        function handleEnterKey(element, textarea) {
            const content = textarea.value;
            const cursorPosition = textarea.selectionStart;
            const id = element.getAttribute('data-id');
            const prevId = element.getAttribute('data-prev-id');

            if (cursorPosition === content.length) {
                handleEnterAtEnd(element, content, id, prevId);
            }
        }
        
        function handleEnterAtEnd(element, content, id, prevId) {
            const newId = generateSentenceId();
            const newWrapper = createSentenceWrapper(newId, id, '');

            const currentWrapper = element.closest('.sentence-wrapper');
            currentWrapper.parentNode.insertBefore(newWrapper, currentWrapper.nextSibling);

            // Send two sentence request
            const firstRequest = { id: id, prevId: prevId, content: content };
            const secondRequest = { id: newId, prevId: id, content: '' };
            
            sendTwoSentenceUpdate(firstRequest, secondRequest, () => {
                console.log('TwoSentenceUpdate completed');
            });
        }
        
        // Test button
        document.body.innerHTML += '<button onclick="simulateEnterKey()">Simulate Enter Key</button>';
    </script>
</body>
</html>